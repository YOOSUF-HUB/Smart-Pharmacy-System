{% extends 'Medicine_inventory/base.html' %}
{% load static %}
{% block content %}
<style>
  *, *::before, *::after {
    font-family: "Montserrat", sans-serif !important;
  }
  
  body {
    background-color: #f9fafb;
  }

  /* Smooth transitions for cards */
  .card-hover {
    transition: all 0.3s ease-in-out;
  }
  .card-hover:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  }

  /* Table enhancements */
  .custom-table thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #f3f4f6;
  }
  .custom-table tbody tr:nth-child(even) {
    background-color: #fafafa;
  }
</style>

<!-- Header Section -->
<div class="flex flex-col sm:flex-row justify-between items-center mb-10 mt-6 px-4 sm:px-12">
  <!-- Logo + Title -->
  <div class="flex items-center gap-3 sm:gap-5 mb-4 sm:mb-0">
    <img src="{% static 'MediSyn_Logo/1.png' %}" alt="Logo" class="h-12 w-auto sm:h-16 drop-shadow-md">
    <h2 class="text-3xl sm:text-4xl font-extrabold bg-gradient-to-r from-cyan-600 to-purple-600 text-transparent bg-clip-text">
      Inventory Dashboard
    </h2>
  </div>

  <!-- Navigation -->
  <div class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-4 sm:mb-0">
    <a href="{% url 'medicine_table' %}" class="px-4 py-2 sm:px-5 sm:py-2.5 text-sm sm:text-base border border-cyan-600 text-cyan-600 font-semibold rounded-lg hover:bg-cyan-600 hover:text-white transition">
      Medicinal Products
    </a>
    <a href="{% url 'non_medicine:product_list' %}" class="px-4 py-2 sm:px-5 sm:py-2.5 text-sm sm:text-base border border-purple-600 text-purple-700 font-semibold rounded-lg hover:bg-purple-600 hover:text-white transition">
      Non-Medical Products
    </a>
  </div>

  <!-- User Menu -->
  <div class="flex items-center gap-4 bg-white/80 backdrop-blur-sm shadow-md px-5 py-3 rounded-xl border border-gray-200">
    {% if user.is_authenticated %}
      <div class="flex items-center gap-2">
        <div class="w-9 h-9 rounded-full bg-gradient-to-r from-cyan-500 to-purple-600 flex items-center justify-center text-white font-bold">
          {{ user.username|first|upper }}
        </div>
        <span class="text-sm sm:text-base text-gray-700 font-medium">
          Hi, <span class="font-semibold">{{ user.username }}</span>
        </span>
      </div>
      <a href="{% url 'logout' %}" class="px-4 py-2 text-sm font-semibold rounded-lg bg-red-500 text-white hover:bg-red-600 transition">
        Logout
      </a>
    {% else %}
      <a href="{% url 'login' %}" class="px-4 py-2 text-sm font-semibold rounded-lg bg-green-600 text-white hover:bg-green-700 transition">
        Login
      </a>
    {% endif %}
  </div>
</div>

<hr class="border-purple-500 mb-10">

<!-- Metric Cards -->
<div class="container mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Medicines -->
  <h3 class="text-lg font-bold text-cyan-700 mb-4">Medicinal Products</h3>
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 mb-12">
    <div class="bg-white border-l-4 border-cyan-500 rounded-xl shadow card-hover p-6 text-center">
      <h5 class="text-sm font-medium text-cyan-600 mb-2">Total Medicines</h5>
      <h3 class="text-3xl text-cyan-700 font-extrabold">{{ total_medicines }}</h3>
    </div>
    <div class="bg-white border-l-4 border-red-500 rounded-xl shadow card-hover p-6 text-center">
      <h5 class="text-sm font-medium text-red-500 mb-2">Low Stock</h5>
      <h3 class="text-3xl text-red-600 font-extrabold">{{ low_stock_count }}</h3>
    </div>
    <div class="bg-white border-l-4 border-yellow-400 rounded-xl shadow card-hover p-6 text-center">
      <h5 class="text-sm font-medium text-yellow-500 mb-2">Near Expiry</h5>
      <h3 class="text-3xl text-yellow-500 font-extrabold">{{ near_expiry_count }}</h3>
    </div>
    <div class="bg-white border-l-4 border-gray-400 rounded-xl shadow card-hover p-6 text-center">
      <h5 class="text-sm font-medium text-slate-600 mb-2">Expired</h5>
      <h3 class="text-3xl text-slate-700 font-extrabold">{{ expired_count }}</h3>
    </div>
  </div>

  <!-- Non-Medicines -->
  <h3 class="text-lg font-bold text-purple-700 mb-4">Non-Medical Products</h3>
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 mb-12">
    <div class="bg-white border-l-4 border-purple-500 rounded-xl shadow card-hover p-6 text-center">
      <h5 class="text-sm font-medium text-purple-600 mb-2">Total Products</h5>
      <h3 class="text-3xl text-purple-700 font-extrabold">{{ total_nonmedical }}</h3>
    </div>
    <div class="bg-white border-l-4 border-red-500 rounded-xl shadow card-hover p-6 text-center">
      <h5 class="text-sm font-medium text-red-500 mb-2">Low Stock</h5>
      <h3 class="text-3xl text-red-600 font-extrabold">{{ nonmedical_low_stock_count }}</h3>
    </div>
    <div class="bg-white border-l-4 border-green-500 rounded-xl shadow card-hover p-6 text-center">
      <h5 class="text-sm font-medium text-green-600 mb-2">Active Products</h5>
      <h3 class="text-3xl text-green-600 font-extrabold">{{ nonmedical_active_count }}</h3>
    </div>
    <div class="bg-white border-l-4 border-gray-400 rounded-xl shadow card-hover p-6 text-center">
      <h5 class="text-sm font-medium text-slate-600 mb-2">Categories</h5>
      <h3 class="text-3xl text-slate-700 font-extrabold">{{ nonmedical_categories_count }}</h3>
    </div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
    <div class="bg-white shadow-xl rounded-2xl p-6 card-hover">
      <h2 class="text-lg font-bold text-slate-800 mb-4">Medicines by Category</h2>
      <div class="relative h-72"><canvas id="categoryChart1"></canvas></div>
    </div>
    <div class="bg-white shadow-xl rounded-2xl p-6 card-hover">
      <h2 class="text-lg font-bold text-slate-800 mb-4">Non-Medicines by Category</h2>
      <div class="relative h-72"><canvas id="categoryChart2"></canvas></div>
    </div>
  </div>

  <!-- Recent Medicines Table -->
  <div class="bg-white shadow-xl rounded-2xl p-6 mb-12 overflow-x-auto card-hover">
    <h5 class="text-lg font-bold text-slate-800 mb-6">Recently Added Medicines</h5>
    <table class="custom-table min-w-full text-sm text-left text-gray-700 rounded-lg overflow-hidden">
      <thead>
        <tr class="bg-gray-100 text-slate-700 uppercase text-xs tracking-wider">
          <th class="py-3 px-4">Name</th>
          <th class="py-3 px-4">Brand</th>
          <th class="py-3 px-4 hidden sm:table-cell">Category</th>
          <th class="py-3 px-4">Quantity</th>
          <th class="py-3 px-4 hidden md:table-cell">Expiry Date</th>
          <th class="py-3 px-4">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for med in recent_medicines %}
        <tr class="border-b hover:bg-gray-50">
          <td class="py-3 px-4">{{ med.name }}</td>
          <td class="py-3 px-4">{{ med.brand }}</td>
          <td class="py-3 px-4 hidden sm:table-cell">{{ med.category }}</td>
          <td class="py-3 px-4">{{ med.quantity_in_stock }}</td>
          <td class="py-3 px-4 hidden md:table-cell">{{ med.expiry_date }}</td>
          <td class="py-3 px-4">
            {% if med.is_expired %}
              <span class="bg-slate-700 text-white text-xs px-3 py-1 rounded-full">Expired</span>
            {% elif med.is_near_expiry %}
              <span class="bg-yellow-400 text-black text-xs px-3 py-1 rounded-full">Near Expiry</span>
            {% elif med.low_stock %}
              <span class="bg-red-500 text-white text-xs px-3 py-1 rounded-full">Low Stock</span>
            {% else %}
              <span class="bg-cyan-500 text-white text-xs px-3 py-1 rounded-full">OK</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-gray-500 py-6">No recent medicines added.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Action Log -->
  <div class="bg-white shadow-xl rounded-2xl p-6 card-hover">
    <h2 class="text-lg font-bold text-slate-800 mb-2">Medicine Inventory Action Log</h2>
    <p class="text-sm text-slate-500 mb-6">Recent additions, updates, and deletions in the inventory.</p>
    <ul class="divide-y divide-gray-200">
      {% for action in recent_actions %}
      <li class="py-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 hover:bg-slate-50 px-4 rounded-lg transition">
        <div class="flex-grow">
          <strong class="text-sm text-slate-800 font-semibold">
            {% if action.medicine %}{{ action.medicine.name }}{% else %}{{ action.medicine_name }}{% endif %}
          </strong>
          <span class="block text-xs text-slate-500">Batch: {% if action.medicine %}{{ action.medicine.batch_number }}{% else %}{{ action.batch_number }}{% endif %}</span>
        </div>
        <div class="flex flex-wrap items-center gap-2 sm:gap-4">
          <span class="text-[11px] font-semibold text-blue-900 bg-blue-100 px-3 py-1 rounded-full">By: {{ action.user.username }}</span>
          <span class="text-[11px] font-semibold text-cyan-900 bg-cyan-100 px-3 py-1 rounded-full">{{ action.get_action_display }}</span>
          <small class="text-gray-500 text-xs">{{ action.timestamp|date:"F j, Y, h:i A" }}</small>
        </div>
      </li>
      {% empty %}
      <li class="py-6 text-center text-gray-500 text-sm">No recent actions recorded.</li>
      {% endfor %}
    </ul>

    <!-- Pagination -->
    <div class="mt-6 flex justify-center">
      <nav class="inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
        {% if recent_actions.has_previous %}
          <a href="?page={{ recent_actions.previous_page_number }}" class="px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm text-gray-500 hover:bg-gray-50">‹</a>
        {% endif %}

        {% for num in recent_actions.paginator.page_range %}
          {% if recent_actions.number == num %}
            <span class="px-4 py-2 border border-blue-500 bg-blue-50 text-blue-600 text-sm font-medium">{{ num }}</span>
          {% elif num > recent_actions.number|add:'-3' and num < recent_actions.number|add:'3' %}
            <a href="?page={{ num }}" class="px-4 py-2 border border-gray-300 bg-white text-sm text-gray-500 hover:bg-gray-50">{{ num }}</a>
          {% endif %}
        {% endfor %}

        {% if recent_actions.has_next %}
          <a href="?page={{ recent_actions.next_page_number }}" class="px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm text-gray-500 hover:bg-gray-50">›</a>
        {% endif %}
      </nav>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('categoryChart1').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: {{ category_labels|safe }},
      datasets: [{
        label: 'Medicine Count',
        data: {{ category_counts|safe }},
        backgroundColor: 'rgba(45, 199, 198, 0.8)',
        borderRadius: 8,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  });

  const ctx2 = document.getElementById('categoryChart2').getContext('2d');
  new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: {{ nonmed_category_labels|safe }},
      datasets: [{
        label: 'Non-Medicine Count',
        data: {{ nonmed_category_counts|safe }},
        backgroundColor: 'rgba(139, 92, 246, 0.8)',
        borderRadius: 8,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  });
</script>
{% endblock %}
